# 网络节点

## 网关

### 定义

**网关（Gateway）** 是一个网络设备，充当**两个不同网络之间的 “中转站”**，负责在不同网段、不同网络协议之间转发数据。它的核心作用是打破网络之间的隔离，实现跨网络的通信。

日常场景中，路由器的内网 IP（如 `192.168.1.1`）就是局域网的**默认网关**；企业环境里，网关可能是专门的路由设备或防火墙。

### 路由表中网关的具体作用

路由表的每条路由条目格式通常是：`目标网段 + 子网掩码 + 网关 + 出口接口`。

网关在路由转发流程中是**核心决策节点**，具体工作逻辑如下：

1. **判断目标网段是否直连**：当主机要发送数据包到目标 IP 时，会先通过子网掩码计算目标 IP 是否和自身在**同一网段**：

   - 若在同一网段：直接通过 ARP 协议获取目标主机的 MAC 地址，直连发送数据，不需要经过网关。
   - 若不在同一网段：主机无法直接定位目标主机，会将数据包发送给网关，由网关负责后续转发。

2. **跨网段通信的 “桥梁”**：网关是跨网段数据的必经转发节点。举个典型例子：

   - 你的电脑（内网 IP `192.168.1.100`）要访问百度（公网 IP `180.101.50.188`），两者属于不同网段。
   - 电脑会把数据包发给默认网关（路由器内网 IP `192.168.1.1`）。
   - 网关（路由器）收到数据包后，通过自身的公网 IP 将数据转发到互联网，最终送达目标服务器。

3. **协议转换与网络适配**：网关不仅能转发同协议的数据包，还能处理不同网络协议之间的转换。比如：

   - 内网是 TCP/IP 协议，另一个网络是 ATM 协议（老式专网常用），网关可以将 TCP/IP 数据包转换成 ATM 格式，实现两个异构网络的互通。
   - 应用层的 API 网关（如 Kong、Spring Cloud Gateway）也属于网关的延伸，能实现 HTTP 和 RPC 协议的转换、请求路由等功能。

4. **网络隔离与安全管控**：网关同时承担安全边界的角色：

   - 做 NAT 转换：内网主机通过网关的公网 IP 共享上网，隐藏内网真实 IP，提升安全性。

     做防火墙过滤：网关可以配置规则，拦截非法数据包（比如阻止外网访问内网的敏感端口），保障内网安全。

### 网关和路由器的区别

很多人会混淆两者，核心区别在于**功能范围**：

|   特性   |            网关             |          路由器          |
| :------: | :-------------------------: | :----------------------: |
| 核心功能 |     协议转换 + 跨网转发     |  路径选择 + 同协议转发   |
|   层级   | 可以工作在 OSI 七层的任意层 | 主要工作在网络层（三层） |

日常家用路由器其实是 “多功能网关”，既具备路由器的路径选择能力，也具备网关的 NAT 转换、协议适配能力。

## 网桥

### 简介

Linux Bridge（网桥）是用纯软件实现的虚拟交换机，有着和物理交换机相同的功能。它能够在链路层连接多个网络接口，实现数据包的转发和MAC地址的学习：

- 连接不同的网段，实现OSI二层互通
- MAC学习：学习MAC地址，它会关心每个收到或者发送的数据，关心数据包的来源MAC是从自己的哪个端口来的，然后慢慢的建立地址-端口的对照表（转发表）。

- 报文转发：每个发送一个数据包，它都会提取其目的MAC地址，从自己的地址-端口对照表(转发表)中查找应该由哪个端口把数据包发送出去，然后转发数据。
- 隔离广播域，减少网络拥塞：
  - 局域网内的广播包（如 ARP 请求）会被所有主机接收，网段越大，广播流量越多，容易导致网络拥塞。
  - 网桥会把一个大的局域网划分为多个小的广播域，广播包只会在源网段内泛洪，不会扩散到其他网段，从而降低全网的广播压力。



除了上述功能外，Linux网桥还会产生一个虚拟的网络接口，这个接口可以和普通的网卡一样，配置IP地址(静态或者DHCP)。建立了Linux网桥的这台主机，以及所有连接在这个网桥上的设备，可以通过这个接口与外界进行IP网络层的通信。



网桥通常是搭配KVM、docker等虚拟化技术一起使用的，用于构建虚拟网络。

### 虚拟机中的网桥

真实主机中安装的虚拟主机，需要和外界主机进行通讯的时候，数据需要通过真实主机的网卡进行传输。

但是虚拟主机内核无法对真实主机的网卡进行控制，一般情况下需要将虚拟主机先将数据包发送给真实主机的内核，再由真实主机内核将该数据通过真实物理网卡发送出去，该过程称为NAT（网络地址转换）。虽然可以实现功能，但是数据传输较慢。



可以利用网桥虚拟出来一个接口br0，通过该接口可以将虚拟主机网卡和真实主机网卡直接连接起来，进行正常的数据通讯，提升数据传输效率。该过程又叫**桥接**。

# 网络设备

## 交换机

### 简介

**交换机（Switch）**是一种为所连接的IT设备提供网络通信的设备，主要用于局域网（LAN）中设备之间的数据转发和通信。它工作在OSI模型的数据链路层（第2层），部分高级交换机可以扩展到网络层（第3层），实现更复杂的功能。

交换机能够根据数据帧中的目标MAC地址，将数据帧转发到正确的目标设备，而不是像集线器那样广播到所有设备。这种智能的数据转发机制显著提高了网络通信的效率。



现在家里的路由器其实有了交换机的功能了。

### 交换机的包接收操作

首先，电信号到达网线接口，交换机里的模块进行接收，接下来交换机里的模块将电信号转换为数字信号。然后通过包末尾的 `FCS` 校验错误，如果没问题则放到缓冲区。这部分操作基本和计算机的网卡相同。

但和网卡不同，**交换机的端口不具有 MAC 地址**。计算机的网卡本身具有 MAC 地址，并通过核对收到的包的接收方 MAC 地址判断是不是发给自己的，如果不是发给自己的则丢弃。相对地，交换机的端口不核对接收方 MAC 地址，而是直接接收所有的包并存放到缓冲区中。

将包存入缓冲区后，接下来需要查询一下这个包的接收方 MAC 地址是否已经在 MAC 地址表中有记录了。交换机的 MAC 地址表主要包含两个信息：

- 一个是设备的 MAC 地址，
- 另一个是该设备连接在交换机的哪个端口上。

![交换机的 MAC 地址表](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/23.jpg)

### 当 MAC 地址表找不到指定的 MAC 地址会怎么样？

地址表中找不到指定的 MAC 地址。这可能是因为具有该地址的设备还没有向交换机发送过包，或者这个设备一段时间没有工作导致地址被从地址表中删除了。

这种情况下，交换机无法判断应该把包转发到哪个端口，只能将包转发到除了源端口之外的所有端口上，无论该设备连接在哪个端口上都能收到这个包。

这样做不会产生什么问题，因为以太网的设计本来就是将包发送到整个网络的，然后**只有相应的接收者才接收包，而其他设备则会忽略这个包**。只要返回了响应包，交换机就可以将它的地址写入 MAC 地址表，下次也就不需要把包发到所有端口了。



此外，如果接收方 MAC 地址是一个**广播地址**，那么交换机会将包发送到除源端口之外的所有端口。以下两个属于广播地址：

- MAC 地址中的 `FF:FF:FF:FF:FF:FF`
- IP 地址中的 `255.255.255.255`



## 路由器

### 路由器与交换机的区别

网络包经过交换机之后，现在到达了路由器，并在此被转发到下一个路由器或目标设备。

这一步转发的工作原理和交换机类似，也是通过查表判断包转发的目标。不过在具体的操作过程上，路由器和交换机是有区别的：

- 因为**路由器**是基于 IP 设计的，俗称**三层**网络设备，路由器的各个端口都具有 MAC 地址和 IP 地址；
- 而**交换机**是基于以太网设计的，俗称**二层**网络设备，交换机的端口不具有 MAC 地址。

### 路由器工作流程

路由器的端口具有 MAC 地址，因此它就能够成为以太网的发送方和接收方；同时还具有 IP 地址，从这个意义上来说，它和计算机的网卡是一样的。

当转发包时，首先路由器端口会接收发给自己的以太网包，然后**路由表**查询转发目标，再由相应的端口作为发送方将以太网包发送出去。

#### 路由器的包接收操作

首先，电信号到达网线接口部分，路由器中的模块会将电信号转成数字信号，然后通过包末尾的 `FCS` 进行错误校验。如果没问题则检查 MAC 头部中的**接收方 MAC 地址**，看看是不是发给自己的包，如果是就放到接收缓冲区中，否则就丢弃这个包。

#### 查询路由表确定输出端口

完成包接收操作之后，路由器就会**去掉**包开头的 MAC 头部。当包到达路由器之后，MAC 头部的任务就完成了，于是 MAC 头部就会被丢弃。

接下来，路由器会根据 MAC 头部后方的 `IP` 头部中的内容进行包的转发操作。转发操作分为几个阶段，首先是查询**路由表**判断转发目标。

![路由器转发](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/24.jpg)

假设地址为 `10.10.1.101` 的计算机要向地址为 `192.168.1.100` 的服务器发送一个包，这个包先到达图中的路由器。

判断转发目标的第一步，就是根据包的接收方 IP 地址查询路由表中的目标地址栏，以找到相匹配的记录。路由匹配把每个条目的子网掩码和 `192.168.1.100` IP 做 **& 与运算**后，得到的结果与对应条目的目标地址进行匹配，如果匹配就会作为候选转发目标，如果不匹配就继续与下个条目进行路由匹配。

实在找不到匹配路由时，就会选择**默认路由**，路由表中子网掩码为 `0.0.0.0` 的记录表示「默认路由」。

#### 路由器的发送操作

首先，我们需要根据**路由表的网关列**判断对方的地址：

- 如果网关是一个 IP 地址，则这个IP 地址就是我们要转发到的目标地址，**还未抵达终点**，还需继续需要路由器转发。
- 如果网关为空，则 IP 头部中的接收方 IP 地址就是要转发到的目标地址，也是就终于找到 IP 包头里的目标地址了，说明**已抵达终点**。



知道对方的 IP 地址之后，接下来需要通过 `ARP` 协议根据 IP 地址查询 MAC 地址，并将查询的结果作为接收方 MAC 地址。接下来是发送方 MAC 地址字段，这里填写输出端口的 MAC 地址。还有一个以太类型字段，填写 `0800` （十六进制）表示 IP 协议。

网络包完成后，接下来会将其转换成电信号并通过端口发送出去。这一步的工作过程和计算机也是相同的。

发送出去的网络包会通过**交换机**到达下一个路由器。接下来，下一个路由器会将包转发给再下一个路由器，经过层层转发之后，网络包就到达了最终的目的地。



在网络包传输的过程中，**源 IP 和目标 IP 始终是不会变的，一直变化的是 MAC 地址**，因为需要 MAC 地址在以太网内进行两个设备之间的包传输。